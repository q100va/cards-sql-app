<div>
  <app-base-list [params]="params()" [showSpinner]="loading()"
    (defaultAddressFilterValue)="setDefaultAddrFilter($event)" (selectedColumns)="changeColumnsView($event)"
    (allFilterParametersChange)="onAllFilterParametersChange($event)" (addWasClicked)="onAddOwnerClick()">

    <table mat-table [dataSource]="dataSource" matSort (matSortChange)="sortData($event)">
      <!-- User Name Column -->
      <ng-container matColumnDef="userName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{'TABLE.COLUMNS.USER_NAME' | translate}}</th>
        <td mat-cell *matCellDef="let row">
          <div>{{row.userName}}</div>
          <br>
          @if(allFilterParameters().includeOutdated && hasOutdatedUserNames(row)) {
          <div class="outdated-data">{{'TABLE.OUTDATED_DATA' | translate}}</div>
          @for (item of row.outdatedData.userNames; track item.id) {
          <span class="outdated-data">
            {{item.userName}}
          </span>
          }
          }
        </td>
      </ng-container>

      <!-- Role Column -->
      <ng-container matColumnDef="role">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{'TABLE.COLUMNS.ROLE_NAME' | translate}}</th>
        <td mat-cell *matCellDef="let row"> {{row.roleName}} </td>
      </ng-container>

      <!-- Affiliation/position Column -->
      <ng-container matColumnDef="affiliation">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{'TABLE.COLUMNS.AFFILIATION' | translate}}</th>
        <td mat-cell *matCellDef="let row">
          <div> <span>{{row.affiliation}}</span><br />
            @if (row.position) {<span>{{row.position}}</span><br />}
          </div>
        </td>
      </ng-container>

      <!-- Full Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>{{'TABLE.COLUMNS.FULL_NAME' | translate}}</th>
        <td mat-cell *matCellDef="let row">
          <div> <span>{{row.firstName}}</span><br />
            @if (row.patronymic) {<span>{{row.patronymic}}</span><br />}
            <span>{{row.lastName}}</span>
          </div>
          <br>
          @if(allFilterParameters().includeOutdated && hasOutdatedNames(row)) {
          <div class="outdated-data">{{'TABLE.OUTDATED_DATA' | translate}}</div>
          @for (item of row.outdatedData.names; track item.id) {
          @if(item.firstName) {
          <div class="outdated-data">
            <span>{{item.firstName}}</span><br />
            @if (item.patronymic) {<span>{{item.patronymic}}</span><br />}
            <span>{{item.lastName}}</span>
          </div>
          }
          }
          }
        </td>
      </ng-container>

      <!-- Homes Column -->
      <ng-container matColumnDef="homes">
        <th mat-header-cell *matHeaderCellDef>{{'TABLE.COLUMNS.HOUSES' | translate}}</th>
        <td mat-cell *matCellDef="let row">
          @if (hasHomes(row)) {
          @for (home of row.homes; track $index) {
          <div>
            {{home.name}} ({{home.region.shortName}})
            @if (home.close) {
            - {{'TABLE.NOTES.CLOSE' | translate}}
            } @else if (home.isRestricted) {
            - {{'TABLE.NOTES.DEACTIVATED' | translate}}
            }<br />
          </div>
          }
          }

          @if(allFilterParameters().includeOutdated && hasOutdatedHomes(row)) {
          <div class="outdated-data">{{'TABLE.OUTDATED_DATA' | translate}}</div>
          @for (home of row.outdatedData.homes; track $index) {
          <div class="outdated-data">
            {{home.name}} ({{home.region.shortName}})
            @if (home.close) {
            - {{'TABLE.NOTES.CLOSE' | translate}}
            } @else if (home.isRestricted) {
            - {{'TABLE.NOTES.DEACTIVATED' | translate}}
            }<br />
          </div>
          }
          }
        </td>
      </ng-container>

      <!-- Contact Column -->
      <ng-container matColumnDef="contacts">
        <th mat-header-cell *matHeaderCellDef>{{'TABLE.COLUMNS.CONTACTS' | translate}}</th>
        <td mat-cell *matCellDef="let row">
          @for (item of contactTypes; track $index) {
          @if (row.orderedContacts[item.type]) {
          <div class="outer">
            <div class="inner-left" [title]="item.label | translate">
              <mat-icon [svgIcon]="item.type"></mat-icon>
            </div>
            <div class="inner-right">
              @for (contact of row.orderedContacts[item.type]; track $index) {
              {{ contact.content | contactUrl:item.type }}<br />
              }
            </div>
          </div>
          }
          }

          @if(allFilterParameters().includeOutdated && hasOutdatedContacts(row)) {
          <div class="outdated-data">{{'TABLE.OUTDATED_DATA' | translate}}</div>

          @for (item of contactTypes; track $index) {
          @if (row.outdatedData.contacts[item.type]) {
          <div class="outdated-data">
            <div class="outer">
              <div class="inner-left" [title]="item.label | translate">
                <mat-icon [svgIcon]="item.type"></mat-icon>
              </div>
              <div class="inner-right">
                @for (contact of row.outdatedData.contacts[item.type]; track $index) {
                {{ contact.content | contactUrl:item.type }}<br />
                }
              </div>
            </div>
          </div>
          }
          }
          }
        </td>
      </ng-container>

      <!-- Address Column -->
      <ng-container matColumnDef="address">
        <th mat-header-cell *matHeaderCellDef>{{'TABLE.COLUMNS.ADDRESS' | translate}}</th>
        <td mat-cell *matCellDef="let row">
          @if (row.address.country) {
          {{row.address.country.name}}<br />
          }
          @if (row.address.region) {
          {{row.address.region.shortName}}<br />
          }
          @if (row.address.district) {
          {{row.address.district.shortName}}<br />
          }
          @if (row.address.locality) {
          {{row.address.locality.shortName}}<br />
          }

          @if(allFilterParameters().includeOutdated && hasOutdatedAddresses(row)) {
          <div class="outdated-data">{{'TABLE.OUTDATED_DATA' | translate}}</div>
          @for (address of row.outdatedData.addresses; track $index) {
          <div class="outdated-data">

            @if (address.country) {
            {{address.country.name}}<br />
            }
            @if (address.region) {
            {{address.region.shortName}}<br />
            }
            @if (address.district) {
            {{address.district.shortName}}<br />
            }
            @if (address.locality) {
            {{address.locality.shortName}}<br />
            }

          </div>
          }
          }
        </td>
      </ng-container>

      <!-- Date Of Start Column -->
      <ng-container matColumnDef="dateOfStart">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{'TABLE.COLUMNS.START_DATE' | translate}}</th>
        <td mat-cell *matCellDef="let row">
          {{dateUtils.transformDate(row.dateOfStart)}}
      </ng-container>

      <!-- Comment Column -->
      <ng-container matColumnDef="comment">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{'TABLE.COLUMNS.COMMENT' | translate}}</th>
        <td mat-cell *matCellDef="let row">
          {{row.comment}}
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="isRestricted">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{'TABLE.COLUMNS.STATUS' | translate}}</th>
        <td mat-cell *matCellDef="let row">
          @if (row.isRestricted) {
          {{('TABLE.NOTES.BLOCKED_FROM' | translate) + dateUtils.transformDate(row.dateOfRestriction)}}<br />
          {{row.causeOfRestriction}}
          } @else {
          {{'TABLE.NOTES.ACTIVE' | translate}}
          }
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>{{'TABLE.COLUMNS.ACTIONS' | translate}}</th>
        <td mat-cell *matCellDef="let row">
          <div class="center">
            <button mat-icon-button [matMenuTriggerFor]="menu" [title]="'TABLE.MENU.OPEN_LIST_TITLE'  | translate"
              appBlurOnClick>
              <mat-icon>
                keyboard_double_arrow_down
              </mat-icon>
            </button>
            <mat-menu #menu="matMenu" xPosition="before">
              <button mat-menu-item (click)="onOpenOwnerCardClick(row.id)" *hasOp="permissions.viewOrEdit">
                <mat-icon fontSet="material-icons-outlined">open_in_new</mat-icon>
                <span>{{'TABLE.MENU.OPEN_CARD' | translate}}</span>
              </button>
              @if(kind() == 'user'){
              <button mat-menu-item (click)="onShowUsersOrdersClick(row.id)" *hasOp="permissions.viewOrders">
                <mat-icon fontSet="material-icons-outlined" fontSet="material-icons-outlined">list_alt</mat-icon>
                <span>{{'TABLE.MENU.OPEN_ORDERS' | translate}}</span>
              </button>
              <button mat-menu-item (click)="onShowUsersSubscribersClick(row.id)" *hasOp="permissions.viewVolunteers">
                <mat-icon>hub</mat-icon>
                <span>{{'TABLE.MENU.OPEN_SUBSCRIBERS' | translate}}</span>
              </button>
              <button mat-menu-item (click)="onShowUsersVolunteersClick(row.id)" *hasOp="permissions.viewVolunteers">
                <mat-icon>groups</mat-icon>
                <span>{{'TABLE.MENU.OPEN_VOLUNTEERS' | translate}}</span>
              </button>
              }
              @if(kind() == 'partner'){
              <button mat-menu-item (click)="onShowPartnerHomesClick(row.id)" *hasOp="permissions.viewHomes">
                <mat-icon>house</mat-icon>
                <span>{{'TABLE.MENU.OPEN_HOMES' | translate}}</span>
              </button>
              }
              <button mat-menu-item [disabled]="row.isRestricted" (click)="onBlockOwnerClick(row.id, row.userName)"
                *hasOp="permissions.block">
                <mat-icon fontSet="material-icons-outlined">lock</mat-icon>
                <span>{{'TABLE.MENU.BLOCK_OWNER' | translate}}</span>
              </button>
              <button mat-menu-item [disabled]="!row.isRestricted" (click)="onUnblockOwnerClick(row.id, row.userName)"
                *hasOp="permissions.unblock">
                <mat-icon fontSet="material-icons-outlined">lock_open</mat-icon>
                <span>{{'TABLE.MENU.UNBLOCK_OWNER' | translate}}</span>
              </button>
              <button mat-menu-item (click)="onDeleteOwnerClick(row.id, row.userName)" *hasOp="permissions.delete">
                <mat-icon fontSet="material-icons-outlined">delete_outlined</mat-icon>
                <span>{{'TABLE.MENU.DELETE_OWNER' | translate}}</span>
              </button>
            </mat-menu>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns;"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <!-- Row shown when there is no matching data. -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="4">>{{'TABLE.NO_DATA_FOR_QUERY' | translate}}</td>
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="pageSizeOptions" [length]="length()" [pageSize]="pageSize()"
      (page)="onChangedPage($event)"></mat-paginator>

  </app-base-list>
</div>
