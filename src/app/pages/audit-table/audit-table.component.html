<mat-card class="audit-table-card" appearance="outlined">
  <!-- Title -->
  <mat-card-header>
    <mat-card-title>Audit History</mat-card-title>
  </mat-card-header>
  <br />

  <!-- Content -->
  <mat-card-content>
    <p-table #dt2 [value]="records()" dataKey="id" [rowTrackBy]="rowTrackBy" [tableStyle]="{ 'min-width': '75rem' }"
      [loading]="isLoading()" [globalFilterFields]="['date', 'model', 'action', 'entityId', 'userId', 'correlationId']"
      (onFilter)="onFilter($event.filters)">
      <ng-template #header>
        <tr>
          <th style="width:18%">Date</th>
          <th style="width:12%">Model</th>
          <th style="width:12%">Action</th>
          <th style="width:9%">EntityId</th>
          <th style="width:9%">UserId</th>
          <th style="width:12%">CorrelationId</th>
          <th style="width:26%">Changes (diff)</th>
          <th style="width:3%">IP</th>
        </tr>
        <tr>
          <th>
            <p-columnFilter field="date" type="date" [matchMode]="'passThrough'" [showMenu]="false"
              [showClearButton]="false">
              <ng-template #filter let-value let-filter="filterCallback">
                <p-iconfield>
                  <p-datepicker [(ngModel)]="rangeDates" selectionMode="range" [readonlyInput]="true"
                    placeholder="Pick and apply" [showIcon]="false" appendTo="body" [style]="{ width: '18rem'}" />
                  <p-inputicon class="pi pi-check" [style.visibility]="rangeDates ? 'visible' : 'hidden'"
                    [style.pointer-events]="rangeDates ? 'auto' : 'none'" (click)="onRangeSelect(filter)"
                    iconPosition="right" [style]="{ right: '.8rem' }" />
                  <p-inputicon class="pi pi-times" [style.visibility]="rangeDates ? 'visible' : 'hidden'"
                    [style.pointer-events]="rangeDates ? 'auto' : 'none'" (click)="rangeDates = null; filter(null)"
                    iconPosition="right" [style]="{ right: '2.6rem' }" />
                </p-iconfield>
              </ng-template>
            </p-columnFilter>
          </th>
          <th>
            <p-columnFilter field="model" [matchMode]="'passThrough'" [showMenu]="false" [showClearButton]="false">
              <ng-template #filter let-value let-filter="filterCallback">
                <p-select [options]="models" (onChange)="filter($event.value)" placeholder="Select One"
                  [showClear]="true" [style]="{ 'min-width': '12rem' }">
                </p-select>
              </ng-template>
            </p-columnFilter>
          </th>
          <th>
            <p-columnFilter field="action" [matchMode]="'passThrough'" [showMenu]="false" [showClearButton]="false">
              <ng-template #filter let-value let-filter="filterCallback">
                <p-select [options]="actions" (onChange)="filter($event.value)" placeholder="Select One"
                  [showClear]="true" [style]="{ 'min-width': '12rem' }">
                  <ng-template let-action #item>
                    <p-tag [value]="action"
                      [severity]="action==='create' ? 'success' : action==='update' ? 'info' : 'warn'">
                    </p-tag>
                  </ng-template>
                </p-select>
              </ng-template>
            </p-columnFilter>
          </th>
          <th>
            <p-columnFilter field="entityId" type="text" display="row" [matchMode]="'passThrough'" [showMenu]="false"
              [showClearButton]="false">
              <ng-template pTemplate="filter" let-filter="filterCallback">
                <p-iconfield>
                  <input type="text" pInputText [(ngModel)]="pendingEntityId" placeholder="Type and apply"
                    [style]="{ 'padding-right': '4rem' }" />
                  <p-inputicon class="pi pi-check" [style.visibility]="pendingEntityId ? 'visible' : 'hidden'"
                    [style.pointer-events]="pendingEntityId ? 'auto' : 'none'" (click)="filter(pendingEntityId)"
                    iconPosition="right" [style]="{ right: '.8rem' }" />
                  <p-inputicon class="pi pi-times" [style.visibility]="pendingEntityId ? 'visible' : 'hidden'"
                    [style.pointer-events]="pendingEntityId ? 'auto' : 'none'"
                    (click)="pendingEntityId = ''; filter('')" iconPosition="right" [style]="{ right: '2.6rem' }" />
                </p-iconfield>
              </ng-template>
            </p-columnFilter>
          </th>
          <th>
            <p-columnFilter field="userId" type="text" display="row" [matchMode]="'passThrough'" [showMenu]="false"
              [showClearButton]="false">
              <ng-template pTemplate="filter" let-filter="filterCallback">
                <p-iconfield>
                  <input type="text" pInputText [(ngModel)]="pendingUserId" placeholder="Type and apply"
                    [style]="{ 'padding-right': '4rem' }" />
                  <p-inputicon class="pi pi-check" [style.visibility]="pendingUserId ? 'visible' : 'hidden'"
                    [style.pointer-events]="pendingUserId ? 'auto' : 'none'" (click)="filter(pendingUserId)"
                    iconPosition="right" [style]="{ right: '.8rem' }" />
                  <p-inputicon class="pi pi-times" [style.visibility]="pendingUserId ? 'visible' : 'hidden'"
                    [style.pointer-events]="pendingUserId ? 'auto' : 'none'" (click)="pendingUserId = ''; filter('')"
                    iconPosition="right" [style]="{ right: '2.6rem' }" />
                </p-iconfield>
              </ng-template>
            </p-columnFilter>
          </th>
          <th>
            <p-columnFilter field="correlationId" type="text" display="row" [matchMode]="'passThrough'"
              [showMenu]="false" [showClearButton]="false">
              <ng-template pTemplate="filter" let-filter="filterCallback">
                <p-iconfield>
                  <input type="text" pInputText [(ngModel)]="pendingCorrelationId" placeholder="Type and apply"
                    [style]="{ 'padding-right': '4rem' }" />
                  <p-inputicon class="pi pi-check" [style.visibility]="pendingCorrelationId ? 'visible' : 'hidden'"
                    [style.pointer-events]="pendingCorrelationId ? 'auto' : 'none'"
                    (click)="filter(pendingCorrelationId)" iconPosition="right" [style]="{ right: '.8rem' }" />
                  <p-inputicon class="pi pi-times" [style.visibility]="pendingCorrelationId ? 'visible' : 'hidden'"
                    [style.pointer-events]="pendingCorrelationId ? 'auto' : 'none'"
                    (click)="pendingCorrelationId = ''; filter('')" iconPosition="right"
                    [style]="{ right: '2.6rem' }" />
                </p-iconfield>
              </ng-template>
            </p-columnFilter>
          </th>
          <th></th>
          <th></th>
        </tr>
      </ng-template>
      <ng-template #body let-record>
        <tr>
          <td>
            {{ record.createdAt | date:'short' }}
          </td>
          <td>
            {{ record.model }}
          </td>
          <td>
            {{ record.action }}
          </td>
          <td>
            {{ record.entityId }}
          </td>
          <td>
            {{ record.actorUserId ?? '—' }}
          </td>
          <td>
            @if (record.correlationId) {
            <p-button icon="pi pi-copy" [rounded]="true" [text]="true" severity="secondary"
              (click)="copy(record.correlationId!)" pTooltip="copy correlationId" tooltipPosition="left"
              [style]="{'font-size': '1.2rem'}" />
            <span>{{ record.correlationId!.slice(0,8) }}…</span>
            } @else {
            <ng-container>—</ng-container>
            }
          </td>
          <td>
            @if (isUpdate(record)) {
            <ng-container>
              <ul class="diff-list">
                @for (changedPair of changedPairs(record); track $index) {
                <li>
                  <code><strong>{{ changedPair.key }}: </strong>
                {{ changedPair.from }}</code> → <code>{{ changedPair.to }}</code>
                </li>
                }
              </ul>
            </ng-container>
            } @else {
            <ng-container>
              <pre class="snapshot">{{ snapshot(record) }}</pre>
            </ng-container>
            }
          </td>
          <td>
            {{ record.ip ?? '—' }}
          </td>
        </tr>
      </ng-template>
      <ng-template #emptymessage>
        <tr>
          <td colspan="5">No records found.</td>
        </tr>
      </ng-template>
    </p-table>
    <p-paginator [rows]="pageSize()" [rowsPerPageOptions]="[10,25,50]" [totalRecords]="total()"
      (onPageChange)="onPageChange($event)">
    </p-paginator>
  </mat-card-content>
</mat-card>
