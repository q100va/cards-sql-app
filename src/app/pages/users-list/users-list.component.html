<div>
<!--   <p-confirmdialog /> -->
  <p-toast position="center" />

  <app-base-list [implicitlyDisplayedColumns]="implicitlyDisplayedColumns" (selectedColumns)="changeColumnsView($event)"
    (allFilterParametersChange)="filterParameters.set($event)" (onAddUserWasClicked)="onAddUserClick()">


    <table mat-table [dataSource]="dataSource" matSort (matSortChange)="sortData($event)">

      <ng-container matColumnDef="userName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Имя пользователя </th>
        <td mat-cell *matCellDef="let row">
          <div>{{row.userName}}</div>
          <br>
          @if(allFilterParameters().notOnlyActual && hasOutdatedUserNames(row)) {
          <div class="outdated-data">прежние значения:</div>
          @for (item of row.outdatedData.userNames; track item.id) {
          <span class="outdated-data">
            {{item.userName}}
          </span>
          }
          }
        </td>
      </ng-container>

      <ng-container matColumnDef="role">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Роль </th>
        <td mat-cell *matCellDef="let row"> {{row.roleName}} </td>
      </ng-container>

      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef> ФИО </th>
        <td mat-cell *matCellDef="let row">
          <div> <span>{{row.firstName}}</span><br />
            @if (row.patronymic) {<span>{{row.patronymic}}</span><br />}
            <span>{{row.lastName}}</span>
          </div>
          <br>
          @if(allFilterParameters().notOnlyActual && hasOutdatedNames(row)) {
          <div class="outdated-data">прежние значения:</div>
          @for (item of row.outdatedData.names; track item.id) {
          @if(item.firstName) {
          <div class="outdated-data">
            <span>{{item.firstName}}</span><br />
            @if (item.patronymic) {<span>{{row.patronymic}}</span><br />}
            <span>{{item.lastName}}</span>
          </div>
          }
          }
          }
        </td>
      </ng-container>

      <ng-container matColumnDef="contacts">
        <th mat-header-cell *matHeaderCellDef> Контакты </th>
        <td mat-cell *matCellDef="let row">
          @for (item of contactTypes; track $index) {
          @if (row.orderedContacts[item.type]) {
          <div class="outer">
            <div class="inner-left" [title]="item.label">
              <mat-icon [svgIcon]="item.type"></mat-icon>
            </div>
            <div class="inner-right">
              @for (contact of row.orderedContacts[item.type]; track $index) {
              {{editContact(contact.content, item.type)}}<br />
              }
            </div>
          </div>
          }
          }
          @if(allFilterParameters().notOnlyActual && hasOutdatedContacts(row)) {
          <div class="outdated-data">прежние значения:</div>
          @for (item of contactTypes; track $index) {

          @if (row.outdatedData.contacts[item.type]) {

          <div class="outdated-data">
            <div class="outer">
              <div class="inner-left" [title]="item.label">
                <mat-icon [svgIcon]="item.type"></mat-icon>
              </div>
              <div class="inner-right">
                @for (contact of row.outdatedData.contacts[item.type]; track $index) {
                {{editContact(contact.content, item.type)}}<br />
                }
              </div>
            </div>
          </div>
          }
          }
          }
        </td>
      </ng-container>

      <ng-container matColumnDef="address">
        <th mat-header-cell *matHeaderCellDef> Адрес </th>
        <td mat-cell *matCellDef="let row">
          @if (row.address.country) {
          {{row.address.country.name}}<br />
          }
          @if (row.address.region) {
          {{row.address.region.shortName}}<br />
          }
          @if (row.address.district) {
          {{row.address.district.shortName}}<br />
          }
          @if (row.address.locality) {
          {{row.address.locality.shortName}}<br />
          }

          @if(allFilterParameters().notOnlyActual && hasOutdatedAddresses(row)) {
          <div class="outdated-data">прежние значения:</div>
          @for (address of row.outdatedData.addresses; track $index) {
          <div class="outdated-data">

            @if (address.country) {
            {{address.country.name}}<br />
            }
            @if (address.region) {
            {{address.region.shortName}}<br />
            }
            @if (address.district) {
            {{address.district.shortName}}<br />
            }
            @if (address.locality) {
            {{address.locality.shortName}}<br />
            }

          </div>
          }
          }
        </td>
      </ng-container>

      <ng-container matColumnDef="dateOfStart">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Дата<br />присоединения</th>
        <td mat-cell *matCellDef="let row">
          {{transformDate(row.dateOfStart)}}
      </ng-container>

      <ng-container matColumnDef="comment">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Комментарий </th>
        <td mat-cell *matCellDef="let row">
          {{row.comment}}
        </td>
      </ng-container>

      <ng-container matColumnDef="isRestricted">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Статус </th>
        <td mat-cell *matCellDef="let row">
          @if (row.isRestricted) {
          {{'заблокирован с ' + transformDate(row.dateOfRestriction)}}<br />
          {{row.causeOfRestriction}}
          } @else {
          {{'активен'}}
          }
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Действия </th>
        <td mat-cell *matCellDef="let row">
          <div class="center">
            <button mat-icon-button [matMenuTriggerFor]="menu" title="Открыть перечень" appBlurOnClick>
              <mat-icon>
                keyboard_double_arrow_down
              </mat-icon>
            </button>
            <mat-menu #menu="matMenu" xPosition="before">
              <button mat-menu-item (click)="onOpenUserCardClick(row.id)">
                <mat-icon fontSet="material-icons-outlined">open_in_new</mat-icon>
                <span>открыть карточку</span>
              </button>
              <button mat-menu-item (click)="onShowUsersOrdersClick(row.id)">
                <mat-icon fontSet="material-icons-outlined" fontSet="material-icons-outlined">list_alt</mat-icon>
                <span>показать заявки</span>
              </button>
              <button mat-menu-item (click)="onShowUsersSubscribersClick(row.id)">
                <mat-icon>groups</mat-icon>
                <span>показать подписчиков</span>
              </button>
              <button mat-menu-item [disabled]="row.isRestricted" (click)="onBlockUserClick(row.id)">
                <mat-icon fontSet="material-icons-outlined">lock</mat-icon>
                <span>заблокировать</span>
              </button>
              <button mat-menu-item [disabled]="!row.isRestricted" (click)="onUnblockUserClick(row.id)">
                <mat-icon fontSet="material-icons-outlined">lock_open</mat-icon>
                <span>разблокировать</span>
              </button>
              <button mat-menu-item (click)="onDeleteUserClick(row.id)">
                <mat-icon fontSet="material-icons-outlined">delete_outlined</mat-icon>
                <span>удалить</span>
              </button>
            </mat-menu>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns;"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>


      <!-- Row shown when there is no matching data. -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="4">Не найдены данные, соответствующие запросу"</td>
        <!-- TODO:change inputValue to signal -->
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="pageSizeOptions" [length]="length()" [pageSize]="pageSize"
      (page)="onChangedPage($event)"></mat-paginator>

  </app-base-list>
</div>
